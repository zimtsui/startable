<!DOCTYPE html><html class="default" lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@zimtsui/startable</title><meta name="description" content="Documentation for @zimtsui/startable"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os"</script><header class="tsd-page-toolbar">
<div class="tsd-toolbar-contents container">
<div class="table-cell" id="tsd-search" data-base=".">
<div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M15.7824 13.833L12.6666 10.7177C12.5259 10.5771 12.3353 10.499 12.1353 10.499H11.6259C12.4884 9.39596 13.001 8.00859 13.001 6.49937C13.001 2.90909 10.0914 0 6.50048 0C2.90959 0 0 2.90909 0 6.49937C0 10.0896 2.90959 12.9987 6.50048 12.9987C8.00996 12.9987 9.39756 12.4863 10.5008 11.6239V12.1332C10.5008 12.3332 10.5789 12.5238 10.7195 12.6644L13.8354 15.7797C14.1292 16.0734 14.6042 16.0734 14.8948 15.7797L15.7793 14.8954C16.0731 14.6017 16.0731 14.1267 15.7824 13.833ZM6.50048 10.499C4.29094 10.499 2.50018 8.71165 2.50018 6.49937C2.50018 4.29021 4.28781 2.49976 6.50048 2.49976C8.71001 2.49976 10.5008 4.28708 10.5008 6.49937C10.5008 8.70852 8.71314 10.499 6.50048 10.499Z" fill="var(--color-text)"></path></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div>
<div class="field">
<div id="tsd-toolbar-links"></div></div>
<ul class="results">
<li class="state loading">Preparing search index...</li>
<li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">@zimtsui/startable</a></div>
<div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="3" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="7" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="11" width="14" height="2" fill="var(--color-text)"></rect></svg></a></div></div></header>
<div class="container container-main">
<div class="col-8 col-content">
<div class="tsd-page-title">
<h2>@zimtsui/startable</h2></div>
<div class="tsd-panel tsd-typography">
<a href="#startable" id="startable" style="color: inherit; text-decoration: none;">
  <h1>Startable</h1>
</a>
<p><a href="https://www.npmjs.com/package/@zimtsui/startable"><img src="https://img.shields.io/npm/v/@zimtsui/startable?style=flat-square" alt="Npm package version"></a></p>
<p>Startable 是一个 JavaScript 的服务启停框架。初衷是为了适配阿里开源 Node.js 进程管理器 <a href="https://github.com/midwayjs/pandora">Pandora</a>。</p>

<a href="#预备概念" id="预备概念" style="color: inherit; text-decoration: none;">
  <h2>预备概念</h2>
</a>
<ul>
<li><p>任务/Job/Task</p>
<p>  任务是占有线程的有限时间复杂度算法。任务运行时间与性能有关，性能越强，运行时间越短。</p>
<p>  例如，批处理脚本、异步函数。</p>
</li>
<li><p>服务/Service/Daemon</p>
<p>  服务自己占有线程，有可能自己挂掉，通过事件触发的方式通知用户。服务挂掉之后如果继续访问会导致未定义的后果。</p>
<p>  例如 Node.js 中一个 TCP 连接，就是一个服务。他本身占有协程，如果底层连接断了，这个协程会触发事件。</p>
</li>
<li><p>资源/Resource</p>
<p>  资源自己不占线程，在内存里躺着等被任务调用。</p>
<p>  资源在用户视角里不会自己挂掉。例如 C 语言中一个文件描述符就是一个资源，向用户提供文件访问功能。他本身不占用线程，如果某时刻底层资源挂了，只要用户不去读这个文件描述符，用户态就永远不知道底层资源挂了。如果挂掉之后继续访问会抛出定义好的错误。</p>
</li>
</ul>

<a href="#转换" id="转换" style="color: inherit; text-decoration: none;">
  <h3>转换</h3>
</a>

<a href="#资源--gt-服务" id="资源--gt-服务" style="color: inherit; text-decoration: none;">
  <h4>资源 -&gt; 服务</h4>
</a>
<p>如果一个资源可以产生多种消息，那么同时轮询这些消息需要自己实现多路复用。</p>
<ul>
<li>给每一种消息开一个轮询线程</li>
<li>libuv</li>
</ul>

<a href="#服务--gt-资源" id="服务--gt-资源" style="color: inherit; text-decoration: none;">
  <h4>服务 -&gt; 资源</h4>
</a>
<ul>
<li>信号量队列</li>
</ul>

<a href="#任务--gt-服务" id="任务--gt-服务" style="color: inherit; text-decoration: none;">
  <h4>任务 -&gt; 服务</h4>
</a>
<ul>
<li><a href="https://github.com/zimtsui/pollerloop">Pollerloop</a></li>
</ul>

<a href="#任务--gt-资源" id="任务--gt-资源" style="color: inherit; text-decoration: none;">
  <h4>任务 -&gt; 资源</h4>
</a>
<ul>
<li>Generator</li>
</ul>

<a href="#注意事项" id="注意事项" style="color: inherit; text-decoration: none;">
  <h3>注意事项</h3>
</a>
<p>「回调」与「事件触发」不是平行概念。回调是实现事件触发的方法，回调不止用来实现事件触发，也用来实现异步任务的结果返回。</p>
<p>任务和服务都占有线程，区别不在于实现，而在于语义。一个可取消的异步任务，也可以理解成一个会自动结束的服务。</p>
<p>JavaScript 协程是协作式调度，与抢占式调度相比的优势在于状态切换的过程具有天然事务性。抢占式切换状态需要给状态加锁。</p>

<a href="#服务的特征" id="服务的特征" style="color: inherit; text-decoration: none;">
  <h2>服务的特征</h2>
</a>

<a href="#服务启停的异步性" id="服务启停的异步性" style="color: inherit; text-decoration: none;">
  <h3>服务启停的异步性</h3>
</a>
<p>服务可以有一个异步的启动和停止过程，用户需要等待启停过程结束。</p>
<p>例如一个 TCP Socket 有一个异步的握手和挥手的过程。</p>

<a href="#服务启停的事务性" id="服务启停的事务性" style="color: inherit; text-decoration: none;">
  <h3>服务启停的事务性</h3>
</a>
<p>启停过程本身可能发生异常而失败比如一个 TCP Socket 连接时就没连上。</p>
<p>C 语言打开一个文件的过程由内核确保事务性，打开失败等于没开，打开失败后不需要关闭。而用户态服务的启动过程如果失败了，内部组件可能处于半开不开的不一致状态，因此打开失败后也必须手动关闭。</p>

<a href="#服务之间的依赖性" id="服务之间的依赖性" style="color: inherit; text-decoration: none;">
  <h3>服务之间的依赖性</h3>
</a>
<p>一个服务可能依赖多个其他服务，这种依赖可以是聚合也可以是组合。只有子服务全部离开启动阶段，父服务才算离开启动阶段；只要有一个子服务进入停止阶段，父服务就算进入停止阶段。</p>

<a href="#服务启停的自发性" id="服务启停的自发性" style="color: inherit; text-decoration: none;">
  <h3>服务启停的自发性</h3>
</a>
<p>服务停止过程可能自发开始。</p>
<p>例如比如一个 TCP Socket 可能因可能因网络中断而离开了「正常提供服务中」的状态，不得不自发开始停止过程。</p>

<a href="#用-eventemitter-实现服务" id="用-eventemitter-实现服务" style="color: inherit; text-decoration: none;">
  <h2>用 EventEmitter 实现服务</h2>
</a>
<p>EventEmitter 是 Node.js 中传统的服务实现方法。</p>
<p>假设有一个服务 parent，有三个子服务</p>
<ul>
<li>tcp</li>
<li>child1</li>
<li>child2</li>
</ul>
<p>任何一个子服务挂掉之后，父服务从语义上说也进入了不可用的状态，因此也应该自己挂掉。于是你不得不这么写：</p>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Parent</span><span class="hl-1"> </span><span class="hl-0">extends</span><span class="hl-1"> </span><span class="hl-2">EventEmitter</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">tcp</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">net</span><span class="hl-1">.</span><span class="hl-4">Socket</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child1</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Child1</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child2</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Child2</span><span class="hl-1">();</span><br/><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">constructor</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;close&#39;</span><span class="hl-1">, () </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-0">void</span><span class="hl-1"> </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">());</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;closing&#39;</span><span class="hl-1">, () </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-0">void</span><span class="hl-1"> </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">());</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;closing&#39;</span><span class="hl-1">, () </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-0">void</span><span class="hl-1"> </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">());</span><br/><br/><span class="hl-1">        (</span><span class="hl-0">async</span><span class="hl-1"> () </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-2">Promise</span><span class="hl-1">.</span><span class="hl-4">all</span><span class="hl-1">([</span><br/><span class="hl-1">                </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">, </span><span class="hl-5">&#39;connect&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">                </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">, </span><span class="hl-5">&#39;open&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">                </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">, </span><span class="hl-5">&#39;open&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">            ]);</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">emit</span><span class="hl-1">(</span><span class="hl-5">&#39;open&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">        })().</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-0">void</span><span class="hl-1"> </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">emit</span><span class="hl-1">(</span><span class="hl-5">&#39;error&#39;</span><span class="hl-1">, </span><span class="hl-3">err</span><span class="hl-1">));</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">close</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-6">try</span><span class="hl-1">{</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">readyState</span><span class="hl-1"> = </span><span class="hl-5">&#39;closing&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">emit</span><span class="hl-1">(</span><span class="hl-5">&#39;closing&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">();</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">();</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">.</span><span class="hl-4">end</span><span class="hl-1">();</span><br/><span class="hl-1">            </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-2">Promise</span><span class="hl-1">.</span><span class="hl-4">all</span><span class="hl-1">([</span><br/><span class="hl-1">                </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">.</span><span class="hl-3">readyState</span><span class="hl-1"> === </span><span class="hl-5">&#39;readOnly&#39;</span><span class="hl-1"> ? </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">, </span><span class="hl-5">&#39;end&#39;</span><span class="hl-1">) : </span><span class="hl-2">Promise</span><span class="hl-1">.</span><span class="hl-4">resolve</span><span class="hl-1">&lt;</span><span class="hl-2">void</span><span class="hl-1">&gt;(),</span><br/><span class="hl-1">                </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">.</span><span class="hl-3">readyState</span><span class="hl-1"> !== </span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1"> ? </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">, </span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1">) : </span><span class="hl-2">Promise</span><span class="hl-1">.</span><span class="hl-4">resolve</span><span class="hl-1">&lt;</span><span class="hl-2">void</span><span class="hl-1">&gt;(),</span><br/><span class="hl-1">                </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">.</span><span class="hl-3">readyState</span><span class="hl-1"> !== </span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1"> ? </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">, </span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1">) : </span><span class="hl-2">Promise</span><span class="hl-1">.</span><span class="hl-4">resolve</span><span class="hl-1">&lt;</span><span class="hl-2">void</span><span class="hl-1">&gt;(),</span><br/><span class="hl-1">            ]);</span><br/><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">readyState</span><span class="hl-1"> = </span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">emit</span><span class="hl-1">(</span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">        } </span><span class="hl-6">catch</span><span class="hl-1"> (</span><span class="hl-3">err</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">emit</span><span class="hl-1">(</span><span class="hl-5">&#39;error&#39;</span><span class="hl-1">, </span><span class="hl-3">err</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>
<p>虽然已经不得不写得这么复杂了，但依然存在以下问题</p>
<ul>
<li><p>假设在 parent 启动过程中，child1 比 child2 先启动好。在 child1 已启动好而 child2 还未启动好的这段间隙里，child1 挂了，child1 触发 <code>closing</code> 事件。<code>parent.close</code> 作为 child1 的 <code>closing</code> 事件的回调函数被运行。然而此时 parent 正处于启动中的状态。一个启动中的 parent 被人调用了 close，后果是未定义的。</p>
</li>
<li><p>假设 child2 的某个启动参数，需要从 child1 处获得。即先把 child1 启动好，访问 child1 获取 child2 的启动参数，然后用这个参数启动 child2。那么你得这么写：</p>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Parent</span><span class="hl-1"> </span><span class="hl-0">extends</span><span class="hl-1"> </span><span class="hl-2">EventEmitter</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">tcp</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">net</span><span class="hl-1">.</span><span class="hl-4">Socket</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child1</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Child1</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child2</span><span class="hl-1">?: </span><span class="hl-2">Child2</span><span class="hl-1">;</span><br/><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">constructor</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;close&#39;</span><span class="hl-1">, () </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-0">void</span><span class="hl-1"> </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">());</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;closing&#39;</span><span class="hl-1">, () </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-0">void</span><span class="hl-1"> </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">());</span><br/><br/><span class="hl-1">        (</span><span class="hl-0">async</span><span class="hl-1"> () </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-2">Promise</span><span class="hl-1">.</span><span class="hl-4">all</span><span class="hl-1">([</span><br/><span class="hl-1">                </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">, </span><span class="hl-5">&#39;connect&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">                </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">, </span><span class="hl-5">&#39;open&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">            ]);</span><br/><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Child2</span><span class="hl-1">(</span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">.</span><span class="hl-4">getParamOfChild2</span><span class="hl-1">());</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;closing&#39;</span><span class="hl-1">, () </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-0">void</span><span class="hl-1"> </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">());</span><br/><span class="hl-1">            </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">, </span><span class="hl-5">&#39;open&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">emit</span><span class="hl-1">(</span><span class="hl-5">&#39;open&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">        })().</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-0">void</span><span class="hl-1"> </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">emit</span><span class="hl-1">(</span><span class="hl-5">&#39;error&#39;</span><span class="hl-1">, </span><span class="hl-3">err</span><span class="hl-1">));</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">close</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-6">try</span><span class="hl-1">{</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">readyState</span><span class="hl-1"> = </span><span class="hl-5">&#39;closing&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">emit</span><span class="hl-1">(</span><span class="hl-5">&#39;closing&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">();</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">.</span><span class="hl-4">close</span><span class="hl-1">();</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">.</span><span class="hl-4">end</span><span class="hl-1">();</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-2">Promise</span><span class="hl-1">.</span><span class="hl-4">all</span><span class="hl-1">([</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">.</span><span class="hl-3">readyState</span><span class="hl-1"> === </span><span class="hl-5">&#39;readOnly&#39;</span><span class="hl-1"> ? </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">, </span><span class="hl-5">&#39;end&#39;</span><span class="hl-1">) : </span><span class="hl-2">Promise</span><span class="hl-1">.</span><span class="hl-4">resolve</span><span class="hl-1">&lt;</span><span class="hl-2">void</span><span class="hl-1">&gt;(),</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">.</span><span class="hl-3">readyState</span><span class="hl-1"> !== </span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1"> ? </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">, </span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1">) : </span><span class="hl-2">Promise</span><span class="hl-1">.</span><span class="hl-4">resolve</span><span class="hl-1">&lt;</span><span class="hl-2">void</span><span class="hl-1">&gt;(),</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">.</span><span class="hl-3">readyState</span><span class="hl-1"> !== </span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1"> ? </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">, </span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1">) : </span><span class="hl-2">Promise</span><span class="hl-1">.</span><span class="hl-4">resolve</span><span class="hl-1">&lt;</span><span class="hl-2">void</span><span class="hl-1">&gt;(),</span><br/><span class="hl-1">        ]);</span><br/><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">readyState</span><span class="hl-1"> = </span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1">;</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">emit</span><span class="hl-1">(</span><span class="hl-5">&#39;closed&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    } </span><span class="hl-6">catch</span><span class="hl-1"> (</span><span class="hl-3">err</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-4">emit</span><span class="hl-1">(</span><span class="hl-5">&#39;error&#39;</span><span class="hl-1">, </span><span class="hl-3">err</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span><br/><span class="hl-1">}</span>
</code></pre>
<p>  现在问题来了，假设 chil1 最先启动好，tcp 第二个启动好，在 child1 已启动好而 tcp 还为启动好的这个间隙里，child1 挂了。那么之后找 child1 获取 child2 的启动参数时，将访问到一个已经不可用的 child1，导致未定义的后果。</p>
</li>
</ul>
<p>总之，使用 EventEmitter 写服务，存在数不清的启停一致性的问题。根本原因是服务内部使用的系统服务或子服务可能在 parent 生命周期的任何阶段挂掉。想要解决这些问题实现启停强一致，你不得不花费大量精力严格仔细地设计整个启停过程，代码量起码是上文的两倍，你的精力将无法集中到业务逻辑上。</p>
<p>于是 Startable 应运而生。Startable 是 JavaScript 的服务启停框架，有了他你就可以把心思花在业务逻辑上。当然 Startable 也可以用于启停资源，毕竟资源可以被看成永不自发停止的服务。</p>

<a href="#startable-1" id="startable-1" style="color: inherit; text-decoration: none;">
  <h2>Startable</h2>
</a>
<p>将服务类用 Startable 提供的装饰器套一下，让 Startable 替你解决所有启停一致性问题，你就可以把精力全部投入业务逻辑上。</p>

<a href="#安装" id="安装" style="color: inherit; text-decoration: none;">
  <h3>安装</h3>
</a>
<pre><code class="language-shell"><span class="hl-1">npm </span><span class="hl-5">install</span><span class="hl-1"> </span><span class="hl-5">--save-peer</span><span class="hl-1"> </span><span class="hl-5">@zimtsui/startable</span>
</code></pre>
<p>什么是 <a href="https://nodejs.org/es/blog/npm/peer-dependencies/">peer dependency</a>？</p>

<a href="#基本用法" id="基本用法" style="color: inherit; text-decoration: none;">
  <h3>基本用法</h3>
</a>
<p>Startable 将一个服务的生命周期分为以下阶段</p>
<ul>
<li>READY</li>
<li>STARTING</li>
<li>STARTED</li>
<li>STOPPING</li>
<li>STOPPED</li>
</ul>
<p>使用 <code>$</code> 获取一个服务对象所对应的 Startable。这个 Startable 上有一个 start 方法和一个 stop 方法，这两个方法内部会调用你自己定义的 rawStart 方法和 rawStop 方法。</p>
<pre><code class="language-ts"><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Service</span><span class="hl-1"> {</span><br/><span class="hl-1">    @</span><span class="hl-4">AsRawStart</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStart</span><span class="hl-1">() {}</span><br/><br/><span class="hl-1">    @</span><span class="hl-4">AsRawStop</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStop</span><span class="hl-1">() {}</span><br/><br/><span class="hl-1">    @</span><span class="hl-4">AssertStateAsync</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">someAsyncMethod</span><span class="hl-1">() {}</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-7">// declare function $(service): Startable;</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">StartService</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">: </span><span class="hl-2">Service</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">();</span><br/><span class="hl-1">}</span><br/><span class="hl-6">export</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">StopService</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">: </span><span class="hl-2">Service</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">}</span>
</code></pre>
<p>Startable 会自动处理好所有启停一致性问题。例如</p>
<ul>
<li>如果你在启动过程中调用了 <code>$(service).stop</code>，那么 Startable 会等你的 rawStart 运行方法结束后（无论 rawStart 成败）再调用你的 rawStop。</li>
<li>如果你在启动过程中重复调用了 <code>$(service).start</code>，那么 Startable 不会重复调用你的 rawStart，而是会直接等待正在进行这次的 rawStart 返回。</li>
<li>如果你在启停过程中调用了 <code>service.someAsyncMethod</code>，那么会抛出错误，而不会执行你定义 someAsyncMethod 代码。</li>
</ul>

<a href="#子服务" id="子服务" style="color: inherit; text-decoration: none;">
  <h3>子服务</h3>
</a>

<a href="#组合" id="组合" style="color: inherit; text-decoration: none;">
  <h4>组合</h4>
</a>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Parent</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child1</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Child1</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child2</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Child2</span><span class="hl-1">();</span><br/><br/><span class="hl-1">    @</span><span class="hl-4">AsRawStart</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStart</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    @</span><span class="hl-4">AsRawStop</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStop</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1">?: </span><span class="hl-2">Error</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>
<p><code>$(service).stop</code> 方法可以传入一个可选的 Error 参数用于表示停止原因。</p>
<p><code>$(service).start</code> 方法可以传入一个 onStopping 钩子作为可选回调，用于在停止过程开始时通知外部。当停止过程开始时会在当前事件循环内调用这个 onStopping 钩子，并将你填进 <code>$(service).stop</code> 的表示停止原因的 Error 参数传递给这个 onStopping 钩子。你可以自行定义这个 Error 参数的语义，然后在 onStopping 钩子中根据 Error 参数判断停止的原因。</p>

<a href="#聚合" id="聚合" style="color: inherit; text-decoration: none;">
  <h4>聚合</h4>
</a>
<p>一个 Startable 的子服务也可能是外部注入的。</p>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Parent</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">constructor</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-3">child</span><span class="hl-1">: </span><span class="hl-2">Child</span><span class="hl-1">,</span><br/><span class="hl-1">    ) { }</span><br/><br/><span class="hl-1">    @</span><span class="hl-4">AsRawStart</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStart</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>

<a href="#自发停止" id="自发停止" style="color: inherit; text-decoration: none;">
  <h3>自发停止</h3>
</a>
<p>当自己发生致命内部错误时，就应当调用自己的 <code>.stop()</code>，因为在语义上，此时自己已经结束了「正常提供服务中」的状态。</p>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Service</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">constructor</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">someComponent</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;error&#39;</span><span class="hl-1">, </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>
<p>如果是自发停止则给 <code>$(service).stop</code> 传参，如果是从外部被动停止则不传参，这样就可以在 onStopping 钩子中根据参数是否存在来判断是不是自发停止。</p>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-8">service</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Service</span><span class="hl-1">();</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">startService</span><span class="hl-1">(){</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-3">err</span><span class="hl-1">) </span><span class="hl-4">handleRunningException</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">().</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStoppingException</span><span class="hl-1">);</span><br/><span class="hl-1">    }).</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStartingException</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">stopService</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">}</span>
</code></pre>

<a href="#用-startable-写服务" id="用-startable-写服务" style="color: inherit; text-decoration: none;">
  <h2>用 Startable 写服务</h2>
</a>
<p>现在来看看用 Startable 解决上文 EventEmitter 面临的问题有多优雅。</p>
<p>假设有一个服务 parent，有三个子服务</p>
<ul>
<li>child1</li>
<li>child2</li>
<li>tcp</li>
</ul>
<p>child2 的某个启动参数，需要从 child1 处获得。即先把 child1 启动好，访问 child1 获取 child2 的启动参数，然后用这个参数启动 child2。</p>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Parent</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">tcp</span><span class="hl-1">?: </span><span class="hl-2">net</span><span class="hl-1">.</span><span class="hl-2">Socket</span><span class="hl-1">;</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child1</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Child1</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-3">child2</span><span class="hl-1">?: </span><span class="hl-2">Child2</span><span class="hl-1">;</span><br/><br/><span class="hl-1">    @</span><span class="hl-4">AsRawStart</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStart</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-3">net</span><span class="hl-1">.</span><span class="hl-4">Socket</span><span class="hl-1">();</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;end&#39;</span><span class="hl-1">, () </span><span class="hl-0">=&gt;</span><span class="hl-1"> </span><span class="hl-0">void</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">());</span><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">, </span><span class="hl-5">&#39;connect&#39;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Child2</span><span class="hl-1">(</span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">.</span><span class="hl-4">getParamOfChild2</span><span class="hl-1">());</span><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-3">stop</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    @</span><span class="hl-4">AsRawStop</span><span class="hl-1">()</span><br/><span class="hl-1">    </span><span class="hl-0">private</span><span class="hl-1"> </span><span class="hl-0">async</span><span class="hl-1"> </span><span class="hl-4">rawStop</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">) </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child2</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">child1</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">.</span><span class="hl-4">end</span><span class="hl-1">();</span><br/><span class="hl-1">            </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">once</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">tcp</span><span class="hl-1">, </span><span class="hl-5">&#39;end&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>

<a href="#bad-practices" id="bad-practices" style="color: inherit; text-decoration: none;">
  <h2>Bad practices</h2>
</a>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Service</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">constructor</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">someComponent</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;some fatal error&#39;</span><span class="hl-1">, </span><span class="hl-3">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">handleRunningException</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1">); </span><span class="hl-7">// don&#39;t do this.</span><br/><span class="hl-1">            </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-8">service</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Service</span><span class="hl-1">();</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">startService</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(() </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">().</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStoppingException</span><span class="hl-1">)</span><br/><span class="hl-1">    }).</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStartingException</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">stopService</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">();</span><br/><span class="hl-1">}</span>
</code></pre>
<p>这个例子的问题在于，一个 Service 中出现的一个让你不得不自发停止的致命错误，那么对这个异常的 handle 代码不应写在类定义的里面，因为这个 handle 过程在语义上不属于这个对象的职责，不是你的职责却非要越俎代庖，违反了 OOD 迪米特法则。</p>
<hr>
<pre><code class="language-ts"><span class="hl-0">class</span><span class="hl-1"> </span><span class="hl-2">Service</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">public</span><span class="hl-1"> </span><span class="hl-0">constructor</span><span class="hl-1">() {</span><br/><span class="hl-1">        </span><span class="hl-0">this</span><span class="hl-1">.</span><span class="hl-3">someComponent</span><span class="hl-1">.</span><span class="hl-4">on</span><span class="hl-1">(</span><span class="hl-5">&#39;some fatal error&#39;</span><span class="hl-1">, </span><span class="hl-3">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-0">this</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1">)</span><br/><span class="hl-1">                .</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStoppingException</span><span class="hl-1">); </span><span class="hl-7">// don&#39;t do this.</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>
<p>这个例子的问题在于，一个 Service 的自发停止过程发生异常而失败，Service 的作者决定了如何 handle 这个异常，这违反了 OOD 迪米特法则。</p>
<p>从语义上说，Service 自己只负责应挂尽挂，如何 handle 这个 Service 停止过程的失败是 Service 的用户的职责。</p>
<hr>
<pre><code class="language-ts"><span class="hl-0">const</span><span class="hl-1"> </span><span class="hl-8">service</span><span class="hl-1"> = </span><span class="hl-0">new</span><span class="hl-1"> </span><span class="hl-4">Service</span><span class="hl-1">();</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">startService</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1"> </span><span class="hl-0">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-3">err</span><span class="hl-1">) </span><span class="hl-4">handleRunningException</span><span class="hl-1">(</span><span class="hl-3">err</span><span class="hl-1">);</span><br/><span class="hl-1">    }).</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStartingException</span><span class="hl-1">);</span><br/><span class="hl-1">}</span><br/><span class="hl-0">function</span><span class="hl-1"> </span><span class="hl-4">stopService</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">stop</span><span class="hl-1">().</span><span class="hl-4">catch</span><span class="hl-1">(</span><span class="hl-3">handleStoppingException</span><span class="hl-1">); </span><span class="hl-7">// don&#39;t do this.</span><br/><span class="hl-1">}</span>
</code></pre>
<p>这个例子的问题在于，一个 Service 的自发停止过程发生异常而失败，这个异常的 handle 代码不应写在 <code>stopService</code> 中，因为 <code>$(service).stop</code> 除了在 <code>stopService</code> 中之外还可能在很多地方被调用，不得不写很多遍。</p>

<a href="#协程安全" id="协程安全" style="color: inherit; text-decoration: none;">
  <h2>协程安全</h2>
</a>
<p>写多线程要考虑线程同步问题，一个线程内的连续代码并不一定在连续时间片中运行，他们之间可能插入了其他时间片跑着其他线程的代码。同理，写多协程也要考虑协程同步问题，一个协程内的 await 两侧的连续代码并不一定在连续的事件循环中运行，他们之间可能插入了其他事件循环跑着其他协程的代码。</p>
<p>Startable 内部实现无非是用 Promise 搞来搞去，必然存在协程同步问题。例如如果一个 Startable 被多个协程控制，那么在任意一个协程内</p>
<pre><code class="language-ts"><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">start</span><span class="hl-1">();</span><br/><span class="hl-3">console</span><span class="hl-1">.</span><span class="hl-4">log</span><span class="hl-1">(</span><span class="hl-4">$</span><span class="hl-1">(</span><span class="hl-3">service</span><span class="hl-1">).</span><span class="hl-4">getReadyState</span><span class="hl-1">());</span>
</code></pre>
<p>的结果不一定是 STARTED，完全有可能是 STOPPING。因为在 await 之后完全有可能被切到别的协程，而那个协程又调用了 <code>$(service).stop</code>。</p>
<p>因此想要确保协程安全，需要明确每一个服务的启停由谁控制，正如 C++/Rust 中需要明确指定一个对象的 Owner 才能确保内存安全。</p>
</div></div>
<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
<div class="tsd-navigation settings">
<details class="tsd-index-accordion"><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Settings</h3></summary>
<div class="tsd-accordion-details">
<div class="tsd-filter-visibility">
<h4 class="uppercase">Member Visibility</h4><form>
<ul id="tsd-filter-options">
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></form></div>
<div class="tsd-theme-toggle">
<h4 class="uppercase">Theme</h4><select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div>
<nav class="tsd-navigation primary">
<details class="tsd-index-accordion" open><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Modules</h3></summary>
<div class="tsd-accordion-details">
<ul>
<li class="current selected"><a href="modules.html">@zimtsui/startable</a>
<ul></ul></li></ul></div></details></nav>
<nav class="tsd-navigation secondary menu-sticky">
<ul>
<li class="tsd-kind-enum"><a href="enums/ReadyState.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-enum)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-8-path"></rect><path d="M9.45 16V7.24H14.49V8.224H10.518V10.936H14.07V11.908H10.518V15.016H14.49V16H9.45Z" fill="var(--color-text)" id="icon-8-text"></path></svg>Ready<wbr/>State</a></li>
<li class="tsd-kind-class"><a href="classes/Startable.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-class)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-128-path"></rect><path d="M11.898 16.1201C11.098 16.1201 10.466 15.8961 10.002 15.4481C9.53803 15.0001 9.30603 14.3841 9.30603 13.6001V9.64012C9.30603 8.85612 9.53803 8.24012 10.002 7.79212C10.466 7.34412 11.098 7.12012 11.898 7.12012C12.682 7.12012 13.306 7.34812 13.77 7.80412C14.234 8.25212 14.466 8.86412 14.466 9.64012H13.386C13.386 9.14412 13.254 8.76412 12.99 8.50012C12.734 8.22812 12.37 8.09212 11.898 8.09212C11.426 8.09212 11.054 8.22412 10.782 8.48812C10.518 8.75212 10.386 9.13212 10.386 9.62812V13.6001C10.386 14.0961 10.518 14.4801 10.782 14.7521C11.054 15.0161 11.426 15.1481 11.898 15.1481C12.37 15.1481 12.734 15.0161 12.99 14.7521C13.254 14.4801 13.386 14.0961 13.386 13.6001H14.466C14.466 14.3761 14.234 14.9921 13.77 15.4481C13.306 15.8961 12.682 16.1201 11.898 16.1201Z" fill="var(--color-text)" id="icon-128-text"></path></svg>Startable</a></li>
<li class="tsd-kind-class"><a href="classes/StateError.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-128-path"></use><use href="#icon-128-text"></use></svg>State<wbr/>Error</a></li>
<li class="tsd-kind-interface"><a href="interfaces/OnStopping.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-interface)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-256-path"></rect><path d="M9.51 16V15.016H11.298V8.224H9.51V7.24H14.19V8.224H12.402V15.016H14.19V16H9.51Z" fill="var(--color-text)" id="icon-256-text"></path></svg>On<wbr/>Stopping</a></li>
<li class="tsd-kind-interface"><a href="interfaces/RawStart.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-256-path"></use><use href="#icon-256-text"></use></svg>Raw<wbr/>Start</a></li>
<li class="tsd-kind-interface"><a href="interfaces/RawStop.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-256-path"></use><use href="#icon-256-text"></use></svg>Raw<wbr/>Stop</a></li>
<li class="tsd-kind-function"><a href="functions/_.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-function)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-64-path"></rect><path d="M9.39 16V7.24H14.55V8.224H10.446V11.128H14.238V12.112H10.47V16H9.39Z" fill="var(--color-text)" id="icon-64-text"></path></svg>$</a></li>
<li class="tsd-kind-function"><a href="functions/AsRawStart.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-64-path"></use><use href="#icon-64-text"></use></svg>As<wbr/>Raw<wbr/>Start</a></li>
<li class="tsd-kind-function"><a href="functions/AsRawStop.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-64-path"></use><use href="#icon-64-text"></use></svg>As<wbr/>Raw<wbr/>Stop</a></li>
<li class="tsd-kind-function"><a href="functions/AssertStateAsync.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-64-path"></use><use href="#icon-64-text"></use></svg>Assert<wbr/>State<wbr/>Async</a></li>
<li class="tsd-kind-function"><a href="functions/AssertStateSync.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-64-path"></use><use href="#icon-64-text"></use></svg>Assert<wbr/>State<wbr/>Sync</a></li></ul></nav></div></div>
<div class="container tsd-generator">
<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div>
<div class="overlay"></div><script src="assets/main.js"></script></body></html>